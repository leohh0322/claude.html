<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µí•© ê·¼íƒœ ë¶„ì„ ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background: #f4f7fa; }
        .view { display: none; }
        .view.active { display: block; }
        .month-tabs { display: flex; gap: 12px; margin-bottom: 30px; padding: 20px; background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); flex-wrap: wrap; }
        .month-tab { padding: 12px 24px; border-radius: 10px; background: #f1f5f9; color: #64748b; border: 2px solid transparent; cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 14px; }
        .month-tab:hover { background: #e2e8f0; transform: translateY(-2px); }
        .month-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: #667eea; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .month-tab.loading { opacity: 0.6; cursor: wait; }
        .stat-card { transition: all 0.3s ease; position: relative; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card.clickable { cursor: pointer; }
        .member-list-popup { visibility: hidden; opacity: 0; position: absolute; top: calc(100% + 10px); left: 0; width: 280px; max-height: 350px; background: white; border-radius: 12px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); z-index: 100; padding: 16px; border: 1px solid #e2e8f0; overflow-y: auto; transition: opacity 0.2s ease, visibility 0.2s ease; }
        .stat-card:hover .member-list-popup { visibility: visible; opacity: 1; }
        .member-list-popup::-webkit-scrollbar { width: 6px; }
        .member-list-popup::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .info-card { background: #f8fafc; border-radius: 12px; padding: 20px; border-left: 4px solid #cbd5e1; transition: transform 0.2s; cursor: pointer; position: relative; }
        .info-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); background: #f1f5f9; }
        .info-card::after { content: 'ğŸ”'; position: absolute; top: 10px; right: 10px; font-size: 12px; opacity: 0.3; }
        .info-card.blue { border-left-color: #3b82f6; }
        .info-card.green { border-left-color: #10b981; }
        .info-card.red { border-left-color: #ef4444; }
        .info-card.purple { border-left-color: #8b5cf6; }
        .info-card.cyan { border-left-color: #06b6d4; }
        .label { font-size: 12px; color: #64748b; font-weight: 600; text-transform: uppercase; margin-bottom: 5px; }
        .value { font-size: 24px; font-weight: 800; color: #1e293b; }
        .sub-value { font-size: 13px; color: #94a3b8; margin-top: 4px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 90%; max-width: 800px; border-radius: 20px; padding: 30px; position: relative; max-height: 85vh; overflow-y: auto; }
        .modal-close { position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; color: #64748b; }
        .modal-title { font-size: 20px; font-weight: 700; margin-bottom: 20px; color: #1e293b; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
        .modal-chart-wrapper { height: 350px; width: 100%; margin-bottom: 20px; }
        .modal-list-wrapper { max-height: 400px; overflow-y: auto; background: #f8fafc; border-radius: 10px; padding: 15px; }
        .modal-list-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0; font-size: 14px; }
        .modal-list-item:last-child { border-bottom: none; }
        .nav-button { position: fixed; top: 20px; left: 20px; background: white; color: #667eea; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.3s ease; z-index: 999; }
        .nav-button:hover { background: #667eea; color: white; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.2); }
        select { background: white; color: #1f2937; }
        select option { color: #1f2937; background: white; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { margin-top: 20px; font-size: 16px; color: #64748b; }
        .remain-vacation-card { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); border-radius: 16px; padding: 24px; color: white; margin-bottom: 24px; box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3); }
        .remain-vacation-card .label { color: rgba(255, 255, 255, 0.9); font-size: 14px; margin-bottom: 8px; }
        .remain-vacation-card .value { color: white; font-size: 36px; font-weight: 900; }
        .remain-vacation-card .sub-value { color: rgba(255, 255, 255, 0.8); font-size: 14px; margin-top: 8px; }
    </style>
</head>
<body>
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Google Sheetsì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <!-- êµ¬ì„±ì› ë·° -->
    <div id="memberView" class="view active">
        <button class="nav-button" onclick="showView('ceo')">CEOìš©ìœ¼ë¡œ ì´ë™ â†’</button>
        <div class="modal-overlay" id="memberModalOverlay">
            <div class="modal-content">
                <span class="modal-close" id="memberModalClose">&times;</span>
                <div class="modal-title" id="memberModalTitle">ìƒì„¸ ë‚´ì—­</div>
                <div class="modal-chart-wrapper"><canvas id="memberModalChart"></canvas></div>
                <div class="modal-list-wrapper" id="memberModalList"></div>
            </div>
        </div>
        <div class="p-6 md:p-10">
            <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-8">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                        <div>
                            <h1 id="memberReportTitle" class="text-3xl font-bold mb-2">ğŸ“Š ê·¼íƒœ ì •ì‚° ë¦¬í¬íŠ¸</h1>
                            <p class="opacity-90">ì›”ë³„ íƒ­ì„ ì„ íƒí•˜ê³  êµ¬ì„±ì›ì„ ì„ íƒí•˜ì„¸ìš”</p>
                        </div>
                        <div class="flex items-center gap-4 bg-white bg-opacity-20 p-4 rounded-xl backdrop-blur-sm">
                            <select id="memberUserSelect" disabled class="px-4 py-2.5 rounded-lg border-none font-medium bg-white text-gray-800">
                                <option>ëŒ€ìƒì ì„ íƒ</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="month-tabs" id="memberMonthTabs">
                    <div class="month-tab active" data-month="9ì›”" onclick="memberSwitchMonth('9ì›”')">ğŸ“… 9ì›”</div>
                    <div class="month-tab" data-month="10ì›”" onclick="memberSwitchMonth('10ì›”')">ğŸ‚ 10ì›”</div>
                    <div class="month-tab" data-month="11ì›”" onclick="memberSwitchMonth('11ì›”')">ğŸ 11ì›”</div>
                    <div class="month-tab" data-month="12ì›”" onclick="memberSwitchMonth('12ì›”')">â„ï¸ 12ì›”</div>
                </div>
                <div class="p-6 md:p-8">
                    <!-- ì”ì—¬ ì—°ì°¨ ì¹´ë“œ -->
                    <div class="remain-vacation-card">
                        <div class="label">ğŸ’¸ ì”ì—¬ ì—°ì°¨</div>
                        <div class="value" id="memberRemainVacation">ê³„ì‚° ì¤‘...</div>
                        <div class="sub-value">ì˜¬í•´ ë‚¨ì€ ìœ ê¸‰ íœ´ê°€ ì¼ìˆ˜</div>
                    </div>

                    <!-- í†µê³„ ì¹´ë“œ ê·¸ë¦¬ë“œ -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                        <!-- ê·¼ë¬´ì¼ -->
                        <div class="info-card blue">
                            <div class="label">ğŸ“… ê·¼ë¬´ì¼</div>
                            <div class="value" id="memberWorkDays">-</div>
                            <div class="sub-value">íœ´ì¼ì •ì±…ì´ ì—†ëŠ” ì¼ìˆ˜</div>
                        </div>
                        
                        <!-- ì´ ê·¼ë¬´ì‹œê°„ (íœ´ê°€ ì‚¬ìš©ì‹œê°„ í¬í•¨) -->
                        <div class="info-card green">
                            <div class="label">â° ì´ ê·¼ë¬´ì‹œê°„</div>
                            <div class="value" id="memberTotalWorkHours">-</div>
                            <div class="sub-value">ê·¼ë¬´ì‹œê°„ + íœ´ê°€ì‹œê°„</div>
                        </div>
                        
                        <!-- ì—°ì¥ ê·¼ë¬´ -->
                        <div class="info-card red">
                            <div class="label">ğŸ”¥ ì—°ì¥ ê·¼ë¬´</div>
                            <div class="value" id="memberOvertimeHours">-</div>
                            <div class="sub-value">8ì‹œê°„ ì´ˆê³¼ ê·¼ë¬´ ì‹œê°„</div>
                        </div>
                        
                        <!-- íœ´ê°€ ì‚¬ìš© -->
                        <div class="info-card purple">
                            <div class="label">ğŸ–ï¸ íœ´ê°€ ì‚¬ìš©</div>
                            <div class="value" id="memberVacationUsed">-</div>
                            <div class="sub-value">ì‚¬ìš©í•œ ìœ ê¸‰ íœ´ê°€</div>
                        </div>
                    </div>

                    <!-- ìƒì„¸ í†µê³„ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="info-card cyan" onclick="memberShowModal('dailyChart')">
                            <div class="label">ğŸ“Š ì¼ë³„ ê·¼ë¬´ ì‹œê°„</div>
                            <div class="value" id="memberAvgDaily">-</div>
                            <div class="sub-value">í‰ê·  ì¼ì¼ ê·¼ë¬´ì‹œê°„</div>
                        </div>
                        <div class="info-card red" onclick="memberShowModal('overtimeChart')">
                            <div class="label">â±ï¸ ì—°ì¥ ê·¼ë¬´ ë¶„í¬</div>
                            <div class="value" id="memberOvertimeDays">-</div>
                            <div class="sub-value">ì—°ì¥ ê·¼ë¬´ ì¼ìˆ˜</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CEO ë·° -->
    <div id="ceoView" class="view">
        <button class="nav-button" onclick="showView('member')">â† êµ¬ì„±ì›ìš©ìœ¼ë¡œ ì´ë™</button>
        <div class="p-6 md:p-10">
            <div class="max-w-7xl mx-auto">
                <div class="bg-gradient-to-r from-purple-600 to-purple-800 text-white rounded-2xl p-8 mb-8">
                    <h1 class="text-3xl font-bold mb-2">ğŸ‘‘ CEO ëŒ€ì‹œë³´ë“œ</h1>
                    <p class="opacity-90">ì „ì²´ íŒ€ì˜ ê·¼ë¬´ í˜„í™©ê³¼ í†µê³„ë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
                </div>

                <div class="month-tabs" id="ceoMonthTabs">
                    <div class="month-tab active" data-month="9ì›”" onclick="ceoSwitchMonth('9ì›”')">ğŸ“… 9ì›”</div>
                    <div class="month-tab" data-month="10ì›”" onclick="ceoSwitchMonth('10ì›”')">ğŸ‚ 10ì›”</div>
                    <div class="month-tab" data-month="11ì›”" onclick="ceoSwitchMonth('11ì›”')">ğŸ 11ì›”</div>
                    <div class="month-tab" data-month="12ì›”" onclick="ceoSwitchMonth('12ì›”')">â„ï¸ 12ì›”</div>
                </div>

                <!-- í•µì‹¬ ì§€í‘œ -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card clickable bg-white p-6 rounded-xl shadow-md hover:shadow-lg">
                        <div class="label">ğŸ‘¥ ì´ ì¸ì›</div>
                        <div class="value" id="ceo_stat_totalPeople">-</div>
                        <div class="sub-value">ì „ì²´ êµ¬ì„±ì›</div>
                        <div class="member-list-popup" id="ceoPopupNameList"></div>
                    </div>
                    <div class="stat-card bg-white p-6 rounded-xl shadow-md hover:shadow-lg">
                        <div class="label">â° ì´ ì—°ì¥ê·¼ë¬´</div>
                        <div class="value" id="ceo_stat_totalOver">-</div>
                        <div class="sub-value">ì „ì²´ ì´ˆê³¼ê·¼ë¬´ ì‹œê°„</div>
                    </div>
                    <div class="stat-card clickable bg-white p-6 rounded-xl shadow-md hover:shadow-lg" onclick="ceoShowModal('missingDetails')">
                        <div class="label">âš ï¸ ë¯¸ì…ë ¥ ê±´ìˆ˜</div>
                        <div class="value" id="ceo_stat_missingCount">-</div>
                        <div class="sub-value">ì¶œí‡´ê·¼ ë¯¸ê¸°ë¡</div>
                    </div>
                    <div class="stat-card clickable bg-white p-6 rounded-xl shadow-md hover:shadow-lg" onclick="ceoShowModal('vacationDetails')">
                        <div class="label">ğŸ–ï¸ ì´ íœ´ê°€ì‚¬ìš©</div>
                        <div class="value" id="ceo_stat_totalVacation">-</div>
                        <div class="sub-value">ì „ì²´ íœ´ê°€ ì‚¬ìš©ì¼ìˆ˜</div>
                    </div>
                </div>

                <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-lg font-bold mb-4 text-gray-800">ğŸ¢ ë¶€ì„œë³„ ì´ˆê³¼ê·¼ë¬´ ë¶„í¬</h3>
                        <div class="h-64"><canvas id="ceoDeptChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-lg font-bold mb-4 text-gray-800">ğŸ‘¥ íŒ€ë³„ ì´ˆê³¼ê·¼ë¬´ ë¶„í¬</h3>
                        <div class="h-64"><canvas id="ceoTeamChart"></canvas></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-lg font-bold mb-4 text-gray-800">ğŸ“Š ìš”ì¼ë³„ í‰ê·  ê·¼ë¬´ì‹œê°„</h3>
                        <div class="h-64"><canvas id="ceoTrendChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-lg font-bold mb-4 text-gray-800">ğŸ”¥ TOP 5 ì´ˆê³¼ê·¼ë¬´</h3>
                        <div id="ceoTopList" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CEO ëª¨ë‹¬ -->
        <div class="modal-overlay" id="ceoModalOverlay">
            <div class="modal-content">
                <span class="modal-close" id="ceoModalClose">&times;</span>
                <div class="modal-title" id="ceoModalTitle">ìƒì„¸ ë‚´ì—­</div>
                <div class="modal-list-wrapper" id="ceoModalList"></div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSn4V02FdTxHjzXQPgV-_bZeWgSZK9eKcFsV7VLGjR5dqOuJr-TGJNjnFM-FE7xCGjJjGQZ5qYNnKWy/pub?output=csv';
        
        let globalData = null;
        let currentMemberMonth = '9ì›”';
        let currentCeoMonth = '9ì›”';
        let ceoDeptChart = null;
        let ceoTeamChart = null;
        let ceoTrendChart = null;
        let memberModalChart = null;
        let ceoVacationDetails = [];
        let ceoMissingDetails = [];

        async function initializeData() {
            console.log('ğŸ”„ ë°ì´í„° ë¡œë”© ì‹œì‘...');
            try {
                const response = await fetch(SHEET_URL);
                const csvText = await response.text();
                const parsedData = Papa.parse(csvText, { header: true, skipEmptyLines: true });
                globalData = parsedData.data;
                console.log('âœ… ë°ì´í„° ë¡œë”© ì™„ë£Œ:', globalData.length, 'ê±´');
                memberUpdateView();
                ceoUpdateView();
            } catch (error) {
                console.error('âŒ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
                alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewName + 'View').classList.add('active');
        }

        // === êµ¬ì„±ì› ë·° ê´€ë ¨ í•¨ìˆ˜ë“¤ ===

        function memberSwitchMonth(month) {
            currentMemberMonth = month;
            document.querySelectorAll('#memberMonthTabs .month-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.month === month) tab.classList.add('active');
            });
            memberUpdateView();
        }

        function memberUpdateView() {
            if (!globalData) return;
            console.log(`ğŸ”„ êµ¬ì„±ì› ë·° ì—…ë°ì´íŠ¸ - ${currentMemberMonth}`);
            const monthData = globalData.filter(row => row['ì›”'] === currentMemberMonth);
            memberPopulateUserSelect(monthData);
            memberUpdateStatistics();
        }

        function memberPopulateUserSelect(monthData) {
            const userSelect = document.getElementById('memberUserSelect');
            const users = [...new Set(monthData.map(row => row['ì´ë¦„']).filter(name => name && name.trim() !== ''))].sort();
            userSelect.innerHTML = '<option value="">ëŒ€ìƒì ì„ íƒ</option>' + users.map(user => `<option value="${user}">${user}</option>`).join('');
            userSelect.disabled = false;
            userSelect.onchange = () => memberUpdateStatistics();
        }

        function memberUpdateStatistics() {
            const selectedUser = document.getElementById('memberUserSelect').value;
            if (!selectedUser || !globalData) return;

            console.log(`ğŸ“Š ${selectedUser} í†µê³„ ê³„ì‚° ì¤‘...`);
            const userData = globalData.filter(row => row['ì´ë¦„'] === selectedUser && row['ì›”'] === currentMemberMonth);
            
            // ê·¼ë¬´ì¼ ê³„ì‚°: íœ´ì¼ì •ì±… ì—´ì´ ë¹„ì–´ìˆëŠ” ë‚ ë“¤ì˜ ìˆ˜
            const workDays = userData.filter(row => {
                const holidayPolicy = row['íœ´ì¼ì •ì±…'];
                return !holidayPolicy || holidayPolicy.trim() === '';
            }).length;

            // íœ´ê°€ ì‚¬ìš© ì‹œê°„ ê³„ì‚° (ë¶„ ë‹¨ìœ„)
            let vacationMinutes = 0;
            userData.forEach(row => {
                const vacationPolicy = row['íœ´ê°€ì •ì±…'];
                if (vacationPolicy && vacationPolicy.trim() !== '') {
                    // íœ´ê°€ì •ì±…ì´ ìˆëŠ” ê²½ìš° 8ì‹œê°„(480ë¶„)ìœ¼ë¡œ ê³„ì‚°
                    vacationMinutes += 480;
                }
            });

            // ê¸°ì¡´ ê·¼ë¬´ì‹œê°„ + íœ´ê°€ ì‚¬ìš©ì‹œê°„
            let totalWorkMinutes = 0;
            let overtimeMinutes = 0;
            let overtimeDays = 0;
            const dailyWork = [];

            userData.forEach(row => {
                const workTime = parseToMinutes(row['ì´ ê·¼ë¬´']);
                totalWorkMinutes += workTime;
                
                const overtime = Math.max(0, workTime - 480); // 8ì‹œê°„ ì´ˆê³¼ ê³„ì‚°
                overtimeMinutes += overtime;
                if (overtime > 0) overtimeDays++;
                
                if (workTime > 0) dailyWork.push(workTime);
            });

            // ì´ ê·¼ë¬´ì‹œê°„ì— íœ´ê°€ ì‚¬ìš©ì‹œê°„ ì¶”ê°€
            const totalMinutesWithVacation = totalWorkMinutes + vacationMinutes;

            // ì”ì—¬ ì—°ì°¨ ê³„ì‚° (ê°€ì •: ì—° 15ì¼)
            const totalVacationDays = userData.filter(row => {
                const vacPolicy = row['íœ´ê°€ì •ì±…'];
                return vacPolicy && vacPolicy.trim() !== '';
            }).length;
            const remainingVacation = Math.max(0, 15 - totalVacationDays);

            // í‰ê·  ì¼ì¼ ê·¼ë¬´ì‹œê°„
            const avgDaily = dailyWork.length > 0 ? (dailyWork.reduce((a, b) => a + b, 0) / dailyWork.length) : 0;

            // í™”ë©´ ì—…ë°ì´íŠ¸
            document.getElementById('memberWorkDays').textContent = `${workDays} ì¼`;
            document.getElementById('memberTotalWorkHours').textContent = `${formatHours(totalMinutesWithVacation)} h`;
            document.getElementById('memberOvertimeHours').textContent = `${formatHours(overtimeMinutes)} h`;
            document.getElementById('memberVacationUsed').textContent = `${totalVacationDays} ì¼`;
            document.getElementById('memberRemainVacation').textContent = `${remainingVacation} ì¼`;
            document.getElementById('memberAvgDaily').textContent = `${formatHours(avgDaily)} h`;
            document.getElementById('memberOvertimeDays').textContent = `${overtimeDays} ì¼`;

            document.getElementById('memberReportTitle').textContent = `ğŸ“Š ${selectedUser}ë‹˜ì˜ ${currentMemberMonth} ê·¼íƒœ ë¦¬í¬íŠ¸`;

            console.log(`âœ… ${selectedUser} í†µê³„ ê³„ì‚° ì™„ë£Œ`);
            console.log(`ê·¼ë¬´ì¼: ${workDays}ì¼, ì´ê·¼ë¬´ì‹œê°„: ${formatHours(totalMinutesWithVacation)}h (ê¸°ì¡´: ${formatHours(totalWorkMinutes)}h + íœ´ê°€: ${formatHours(vacationMinutes)}h)`);
        }

        function memberShowModal(type) {
            const selectedUser = document.getElementById('memberUserSelect').value;
            if (!selectedUser) return;

            const userData = globalData.filter(row => row['ì´ë¦„'] === selectedUser && row['ì›”'] === currentMemberMonth);
            const modal = document.getElementById('memberModalOverlay');
            const title = document.getElementById('memberModalTitle');
            const listContainer = document.getElementById('memberModalList');

            if (type === 'dailyChart') {
                title.textContent = `${selectedUser}ë‹˜ì˜ ì¼ë³„ ê·¼ë¬´ì‹œê°„`;
                const dailyData = userData.map(row => ({
                    date: row['ë‚ ì§œ'],
                    work: parseToMinutes(row['ì´ ê·¼ë¬´'])
                })).filter(d => d.work > 0);

                memberCreateChart(dailyData.map(d => d.date), dailyData.map(d => d.work / 60), 'ì¼ë³„ ê·¼ë¬´ì‹œê°„ (h)');
                listContainer.innerHTML = dailyData.map(d => `
                    <div class="modal-list-item">
                        <span>${d.date}</span>
                        <span>${formatHours(d.work)} h</span>
                    </div>
                `).join('');

            } else if (type === 'overtimeChart') {
                title.textContent = `${selectedUser}ë‹˜ì˜ ì—°ì¥ê·¼ë¬´ ë‚´ì—­`;
                const overtimeData = userData.map(row => ({
                    date: row['ë‚ ì§œ'],
                    work: parseToMinutes(row['ì´ ê·¼ë¬´']),
                    overtime: Math.max(0, parseToMinutes(row['ì´ ê·¼ë¬´']) - 480)
                })).filter(d => d.overtime > 0);

                memberCreateChart(overtimeData.map(d => d.date), overtimeData.map(d => d.overtime / 60), 'ì—°ì¥ê·¼ë¬´ ì‹œê°„ (h)');
                listContainer.innerHTML = overtimeData.map(d => `
                    <div class="modal-list-item">
                        <span>${d.date}</span>
                        <span>ì´ ${formatHours(d.work)}h â†’ ì—°ì¥ ${formatHours(d.overtime)}h</span>
                    </div>
                `).join('');
            }

            modal.style.display = 'flex';
        }

        function memberCreateChart(labels, data, label) {
            const ctx = document.getElementById('memberModalChart').getContext('2d');
            if (memberModalChart) memberModalChart.destroy();
            memberModalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true },
                        x: { display: labels.length <= 15 }
                    }
                }
            });
        }

        // ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('memberModalClose').onclick = () => {
            document.getElementById('memberModalOverlay').style.display = 'none';
        };

        // === CEO ë·° ê´€ë ¨ í•¨ìˆ˜ë“¤ ===

        function ceoSwitchMonth(month) {
            currentCeoMonth = month;
            document.querySelectorAll('#ceoMonthTabs .month-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.month === month) tab.classList.add('active');
            });
            ceoUpdateView();
        }

        function ceoUpdateView() {
            if (!globalData) return;
            console.log(`ğŸ”„ CEO ë·° ì—…ë°ì´íŠ¸ - ${currentCeoMonth}`);
            const monthData = globalData.filter(row => row['ì›”'] === currentCeoMonth);
            ceoProcessExcel(monthData);
        }

        function ceoShowModal(type) {
            const modal = document.getElementById('ceoModalOverlay');
            const title = document.getElementById('ceoModalTitle');
            const listContainer = document.getElementById('ceoModalList');

            if (type === 'vacationDetails') {
                title.textContent = 'íœ´ê°€ ì‚¬ìš© ìƒì„¸ ë‚´ì—­';
                listContainer.innerHTML = ceoVacationDetails.map(item => `
                    <div class="modal-list-item">
                        <span>${item.name}</span>
                        <span>${item.days} ì¼</span>
                    </div>
                `).join('');
            } else if (type === 'missingDetails') {
                title.textContent = 'ì¶œí‡´ê·¼ ë¯¸ì…ë ¥ ìƒì„¸ ë‚´ì—­';
                listContainer.innerHTML = ceoMissingDetails.map(item => `
                    <div class="modal-list-item">
                        <span>${item.name}</span>
                        <span class="text-red-600">${item.count} ê±´</span>
                    </div>
                `).join('');
            }

            modal.style.display = 'flex';
        }

        document.getElementById('ceoModalClose').onclick = () => {
            document.getElementById('ceoModalOverlay').style.display = 'none';
        };

        // === ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ ===

        function parseToMinutes(timeStr) {
            if (!timeStr || typeof timeStr !== 'string') return 0;
            const parts = timeStr.trim().split(':');
            if (parts.length >= 2) {
                const hours = parseInt(parts[0]) || 0;
                const minutes = parseInt(parts[1]) || 0;
                return hours * 60 + minutes;
            }
            return 0;
        }

        function formatHours(minutes) {
            return (minutes / 60).toFixed(1);
        }

        function getTotalVacationByMonth(month) {
            if (!globalData) return { total: 0, details: [] };
            
            const monthData = globalData.filter(row => row['ì›”'] === month);
            const vacationStats = {};

            monthData.forEach(row => {
                const name = row['ì´ë¦„'];
                const vacationPolicy = row['íœ´ê°€ì •ì±…'];
                
                if (name && vacationPolicy && vacationPolicy.trim() !== '') {
                    if (!vacationStats[name]) vacationStats[name] = 0;
                    vacationStats[name]++;
                }
            });

            const details = Object.entries(vacationStats).map(([name, days]) => ({ name, days }));
            const total = details.reduce((sum, item) => sum + item.days, 0);

            return { total, details };
        }

        function parseToMinutes(val) {
            if (typeof val === 'string') { const p = val.trim().split(':'); if (p.length >= 2) return parseInt(p[0]) * 60 + parseInt(p[1]); }
            return 0;
        }

        function ceoFormatHours(mins) { return (mins / 60).toFixed(1); }

        function ceoGetTeamCategory(name) {
            if (!name) return 'ê¸°íƒ€';
            const n = name.trim();
            if (n.includes('CEO')) return 'EXCLUDED';
            if (n === 'ê°œë°œíŒ€' || n === 'ê°œë°œíŒ€ì¥' || n === 'CTO') return 'ê°œë°œíŒ€';
            if (n === 'ê²½ì˜ì§€ì›íŒ€' || n === 'ê²½ì˜ì§€ì›íŒ€ì¥') return 'ê²½ì˜ì§€ì›íŒ€';
            if (n === 'ê¸°íš1íŒ€' || n === 'ê¸°íš1íŒ€ì¥') return 'ê¸°íš1íŒ€';
            if (n === 'ê¸°íš2íŒ€' || n === 'COO, ê¸°íš2íŒ€ì¥') return 'ê¸°íš2íŒ€';
            if (n === 'ë©”ë””ì»¬íŒ€' || n === 'ë©”ë””ì»¬íŒ€ì¥') return 'ë©”ë””ì»¬íŒ€';
            if (n === 'í’ˆì§ˆì±…ì„íŒ€ì¥' || n === 'í’ˆì§ˆì±…ì„íŒ€') return 'í’ˆì§ˆì±…ì„íŒ€';
            return 'ê¸°íƒ€';
        }

        function ceoInitCharts(deptData, teamData, trendData) {
            const ctxDept = document.getElementById('ceoDeptChart').getContext('2d');
            if (ceoDeptChart) ceoDeptChart.destroy();
            ceoDeptChart = new Chart(ctxDept, { type: 'doughnut', data: { labels: deptData.labels, datasets: [{ data: deptData.values, backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#6366f1','#94a3b8'], borderWidth: 0, hoverOffset: 20 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 15, font: { size: 10 } } } }, cutout: '65%' } });
            const ctxTeam = document.getElementById('ceoTeamChart').getContext('2d');
            if (ceoTeamChart) ceoTeamChart.destroy();
            ceoTeamChart = new Chart(ctxTeam, { type: 'pie', data: { labels: teamData.labels, datasets: [{ data: teamData.values, backgroundColor: ['#2563eb','#10b981','#f59e0b','#ef4444','#8b5cf6','#6366f1','#475569'], borderWidth: 2, borderColor: '#fff' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 15, font: { size: 11, weight: 'bold' } } } } } });
            const ctxTrend = document.getElementById('ceoTrendChart').getContext('2d');
            if (ceoTrendChart) ceoTrendChart.destroy();
            ceoTrendChart = new Chart(ctxTrend, { type: 'bar', data: { labels: trendData.labels, datasets: [{ label: 'ìš”ì¼ë³„ í‰ê·  ê·¼ë¬´ì‹œê°„ (h)', data: trendData.values, backgroundColor: '#3b82f6', borderRadius: 6, barThickness: 50 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } } } });
        }

        function ceoProcessExcel(data) {
            const users = {}, departments = {}, teams = {}, weekdayTrend = {}, missingStats = {};
            const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const weekdayData = { 'ì›”': [], 'í™”': [], 'ìˆ˜': [], 'ëª©': [], 'ê¸ˆ': [], 'í† ': [], 'ì¼': [] };
            let totalOverMins = 0, totalMissingCount = 0;
            data.forEach(row => {
                const name = row['ì´ë¦„'], dept = row['íšŒì‚¬ë‚´ ì´ë¦„'] || 'ë¯¸ë¶„ë¥˜';
                const dateStr = row['ë‚ ì§œ'];
                const workMins = ceoParseToMinutes(row['ì´ ê·¼ë¬´']);
                const inTime = row['ì¶œê·¼ì‹œê°'], outTime = row['í‡´ê·¼ì‹œê°'], policy = row['ê·¼ë¬´ì •ì±…'], leavePolicy = row['íœ´ê°€ì •ì±…'], holidayType = row['íœ´ì¼êµ¬ë¶„'];
                if (!name) return;
                const userId = `${name}_${dept}`;
                if (!users[userId]) { users[userId] = { name, dept, overMins: 0, totalMins: 0, missingCount: 0 }; if (!missingStats[name]) missingStats[name] = 0; }
                const isOffDay = (leavePolicy && String(leavePolicy).trim() !== '') || (holidayType && String(holidayType).trim() !== '') || (holidayType === 'íœ´ë¬´ì¼') || (holidayType === 'ì£¼íœ´ì¼');
                const isNoPolicy = !policy || String(policy).trim() === '';
                const isTimeMissing = (!inTime || String(inTime).trim() === '') || (!outTime || String(outTime).trim() === '');
                if (!isOffDay && isNoPolicy && isTimeMissing) { users[userId].missingCount++; totalMissingCount++; missingStats[name]++; }
                const dayOver = Math.max(0, workMins - 480);
                users[userId].overMins += dayOver; users[userId].totalMins += workMins;
                if (!departments[dept]) departments[dept] = 0; departments[dept] += dayOver;
                const teamCat = ceoGetTeamCategory(row['ì¡°ì§']);
                if (teamCat !== 'EXCLUDED') { if (!teams[teamCat]) teams[teamCat] = 0; teams[teamCat] += dayOver; }
                if (!isOffDay && dateStr && typeof dateStr === 'string' && dateStr.includes('-')) {
                    try {
                        const d = new Date(dateStr);
                        const dayOfWeek = weekdays[d.getDay()];
                        if (weekdayData[dayOfWeek]) {
                            weekdayData[dayOfWeek].push(workMins);
                        }
                    } catch(e) {}
                }
                totalOverMins += dayOver;
            });
            const weekdayLabels = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
            const weekdayValues = weekdayLabels.map(day => {
                const dayData = weekdayData[day];
                if (dayData.length === 0) return 0;
                const avg = dayData.reduce((sum, val) => sum + val, 0) / dayData.length;
                return ceoFormatHours(avg);
            });
            const vacationData = getTotalVacationByMonth(currentCeoMonth);
            ceoVacationDetails = vacationData.details;
            ceoMissingDetails = Object.entries(missingStats).filter(([name, count]) => count > 0).sort((a, b) => b[1] - a[1]).map(([name, count]) => ({ name, count }));
            const userList = Object.values(users);
            document.getElementById('ceo_stat_totalPeople').innerText = `${userList.length} ëª…`;
            document.getElementById('ceo_stat_totalOver').innerText = `${ceoFormatHours(totalOverMins)} h`;
            document.getElementById('ceo_stat_missingCount').innerText = `${totalMissingCount} ê±´`;
            document.getElementById('ceo_stat_totalVacation').innerText = `${vacationData.total.toFixed(1)} ì¼`;
            document.getElementById('ceoPopupNameList').innerHTML = userList.sort((a,b) => a.name.localeCompare(b.name)).map(u => `<div class="flex justify-between items-center py-2 border-b border-gray-50 hover:bg-gray-50 px-1 rounded"><span class="font-bold text-gray-700">${u.name}</span><span class="text-[10px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full font-medium">${u.dept}</span></div>`).join('');
            const top5 = [...userList].sort((a,b) => b.overMins - a.overMins).slice(0, 5);
            document.getElementById('ceoTopList').innerHTML = top5.map((u,i) => `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl"><div class="flex items-center gap-3"><span class="w-7 h-7 flex items-center justify-center bg-gray-200 rounded-full text-[10px] font-bold">${i+1}</span><div><p class="text-sm font-bold text-gray-800">${u.name}</p><p class="text-[10px] text-gray-500">${u.dept}</p></div></div><div class="text-right"><p class="text-red-600 text-sm font-bold">${ceoFormatHours(u.overMins)}h</p></div></div>`).join('');
            const deptLabels = Object.keys(departments), deptValues = Object.values(departments).map(v => ceoFormatHours(v));
            const teamLabels = Object.keys(teams), teamValues = Object.values(teams).map(v => ceoFormatHours(v));
            ceoInitCharts({ labels: deptLabels, values: deptValues }, { labels: teamLabels, values: teamValues }, { labels: weekdayLabels, values: weekdayValues });
        }

        function ceoParseToMinutes(val) {
            if (typeof val === 'string') { const p = val.trim().split(':'); if (p.length >= 2) return parseInt(p[0]) * 60 + parseInt(p[1]); }
            return 0;
        }

        ceoInitCharts({labels:[],values:[]},{labels:[],values:[]},{labels:[],values:[]});
        initializeData();
        console.log('âœ… Google Sheets ì—°ë™ ê·¼íƒœ ë¶„ì„ ì‹œìŠ¤í…œ ë¡œë“œ ì™„ë£Œ');
    </script>
</body>
</html>
